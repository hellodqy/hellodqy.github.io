<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>PE结构简述 | 快乐小凳凳</title><meta name="author" content="DQY"><meta name="copyright" content="DQY"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="LordPE下载 MS-DOS头：兼容性，在DOS系统下提示无法运行  12345678910111213141516171819202122&#x2F;&#x2F; 直接在VS里面输_IMAGE_DOS_HEADER然后CTRL点击即可看到结构定义，19个字段，重点关注第一个和最后一个typedef struct _IMAGE_DOS_HEADER &amp;#123;      &#x2F;&#x2F; DOS .EXE header">
<meta property="og:type" content="article">
<meta property="og:title" content="PE结构简述">
<meta property="og:url" content="https://dqywy.top/post/15941cfe.html">
<meta property="og:site_name" content="快乐小凳凳">
<meta property="og:description" content="LordPE下载 MS-DOS头：兼容性，在DOS系统下提示无法运行  12345678910111213141516171819202122&#x2F;&#x2F; 直接在VS里面输_IMAGE_DOS_HEADER然后CTRL点击即可看到结构定义，19个字段，重点关注第一个和最后一个typedef struct _IMAGE_DOS_HEADER &amp;#123;      &#x2F;&#x2F; DOS .EXE header">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s1.ax1x.com/2023/07/05/pCyWWoq.jpg">
<meta property="article:published_time" content="2023-07-24T05:40:21.000Z">
<meta property="article:modified_time" content="2023-07-24T05:46:06.518Z">
<meta property="article:author" content="DQY">
<meta property="article:tag" content="PE结构">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2023/07/05/pCyWWoq.jpg"><link rel="shortcut icon" href="/img/%E8%9C%A1%E7%AC%94%E5%B0%8F%E6%96%B0.png"><link rel="canonical" href="https://dqywy.top/post/15941cfe.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="Bzg6eIdkVOEV8oBbF7JjZYrVu-YzUceeqMg3x8jj9dg"/><meta name="baidu-site-verification" content="codeva-XgwnkC6nAo"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"72DNIS4BVB","apiKey":"073252ceb45b51127ff2cdfdfb80ba73","indexName":"hexo","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PE结构简述',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-24 13:46:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><script async src="/js/title.js"></script><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/coin.css"><script src="/js/modify.js"></script><script src="/js/coin.js"></script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://img.gejiba.com/images/0ce1d480d1fff83afca6864f9bb7797c.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">39</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-zhuye"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-daohang"></i><span> 导航</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijian"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-bangzhushouce"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-faxian1"></i><span> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://terminal.dqywy.top/#/"><i class="fa-fw iconfont icon-info"></i><span> 浏览器终端</span></a></li><li><a class="site-page child" href="/air-conditioner/"><i class="fa-fw iconfont icon-kongtiao"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-useryonghu3"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-info"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw iconfont icon-fensi"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw iconfont icon-wode"></i><span> 赞助墙</span></a></li><li><a class="site-page child" href="/ToDoList/"><i class="fa-fw iconfont icon-qiandao"></i><span> 待做清单</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s1.ax1x.com/2023/07/05/pCyWWoq.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="快乐小凳凳"><span class="site-name">快乐小凳凳</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-zhuye"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-daohang"></i><span> 导航</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-shijian"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-bangzhushouce"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-faxian1"></i><span> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://terminal.dqywy.top/#/"><i class="fa-fw iconfont icon-info"></i><span> 浏览器终端</span></a></li><li><a class="site-page child" href="/air-conditioner/"><i class="fa-fw iconfont icon-kongtiao"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-useryonghu3"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-info"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw iconfont icon-fensi"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/reward/"><i class="fa-fw iconfont icon-wode"></i><span> 赞助墙</span></a></li><li><a class="site-page child" href="/ToDoList/"><i class="fa-fw iconfont icon-qiandao"></i><span> 待做清单</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PE结构简述</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-24T05:40:21.000Z" title="发表于 2023-07-24 13:40:21">2023-07-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-07-24T05:46:06.518Z" title="更新于 2023-07-24 13:46:06">2023-07-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PE/">PE</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PE结构简述"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a target="_blank" rel="noopener" href="https://fishc.com.cn/forum.php?mod=attachment&amp;aid=Mjg1OTZ8ZjEzMzUzNDN8MTY4OTk1MjEyMHwxMjU3ODAxfDUxMDQ3">LordPE下载</a></p>
<h2 id="MS-DOS头："><a href="#MS-DOS头：" class="headerlink" title="MS-DOS头："></a>MS-DOS头：</h2><p>兼容性，在DOS系统下提示无法运行</p>
<p><img src="https://s1.ax1x.com/2023/07/24/pCLqd6H.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接在VS里面输_IMAGE_DOS_HEADER然后CTRL点击即可看到结构定义，19个字段，重点关注第一个和最后一个</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DOS_HEADER</span> &#123;</span>      <span class="comment">// DOS .EXE header</span></span><br><span class="line">    WORD   e_magic;                     <span class="comment">// MS-DOS头的标志MZ，固定为4D 5A，实际值为0x5A4D</span></span><br><span class="line">    WORD   e_cblp;                      <span class="comment">// 文件末页的字节数</span></span><br><span class="line">    WORD   e_cp;                        <span class="comment">// 文件页数</span></span><br><span class="line">    WORD   e_crlc;                      <span class="comment">// 重定位</span></span><br><span class="line">    WORD   e_cparhdr;                   <span class="comment">// 区段中头部的大小</span></span><br><span class="line">    WORD   e_minalloc;                  <span class="comment">// 最小附加内存段的需求</span></span><br><span class="line">    WORD   e_maxalloc;                  <span class="comment">// 最大附加内存段的需求</span></span><br><span class="line">    WORD   e_ss;                        <span class="comment">// 初始SS值，用于初始化堆栈</span></span><br><span class="line">    WORD   e_sp;                        <span class="comment">// 初始SP值，用于初始化堆栈指针的值</span></span><br><span class="line">    WORD   e_csum;                      <span class="comment">// 校验和</span></span><br><span class="line">    WORD   e_ip;                        <span class="comment">// 初始化IP寄存器的值，即程序的入口点</span></span><br><span class="line">    WORD   e_cs;                        <span class="comment">// 初始化CS的值，CS:IP</span></span><br><span class="line">    WORD   e_lfarlc;                    <span class="comment">// 重定位表的偏移</span></span><br><span class="line">    WORD   e_ovno;                      <span class="comment">// Overlay number</span></span><br><span class="line">    WORD   e_res[<span class="number">4</span>];                    <span class="comment">// Reserved words</span></span><br><span class="line">    WORD   e_oemid;                     <span class="comment">// OEM厂商的标识</span></span><br><span class="line">    WORD   e_oeminfo;                   <span class="comment">// OEM厂商的信息</span></span><br><span class="line">    WORD   e_res2[<span class="number">10</span>];                  <span class="comment">// Reserved words</span></span><br><span class="line">    LONG   e_lfanew;                    <span class="comment">// 4个字节，偏移为37，指向新的PE头，因为这是DOS头，是为了兼容DOS系统，真正执行需要到PE头</span></span><br><span class="line">  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br></pre></td></tr></table></figure>
<p>编辑器：低地址存放低位数据，<strong>小端</strong>存储</p>
<p>注意编辑器行号的进制要变为<strong>16进制</strong>而不是十进制，偏移是<strong>十六进制</strong>的数据呀！</p>
<h2 id="PE头"><a href="#PE头" class="headerlink" title="PE头"></a>PE头</h2><p>看清程序是32/64位</p>
<p><img src="https://s1.ax1x.com/2023/07/24/pCLqUpD.png" alt=""></p>
<p>标准PE头(每个PE文件都有)和扩展PE头(可有可无)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 32位</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class="line">    DWORD Signature;	<span class="comment">// PE标识：PE-&gt;50 45 00 00，实际值为0x00004550</span></span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;	<span class="comment">// 标准NT头</span></span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;	<span class="comment">// 扩展头，可选</span></span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 64位</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS64</span> &#123;</span></span><br><span class="line">    DWORD Signature;	<span class="comment">// PE标识：PE-&gt;50 45 00 00，实际值为0x00004550</span></span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;	<span class="comment">// 标准NT头</span></span><br><span class="line">    IMAGE_OPTIONAL_HEADER64 OptionalHeader;	<span class="comment">// 可选</span></span><br><span class="line">&#125; IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标准NT头</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span> &#123;</span></span><br><span class="line">    WORD    Machine;	<span class="comment">// 运行平台，指明可运行的处理器平台</span></span><br><span class="line">    WORD    NumberOfSections;	<span class="comment">// 区段数量，.text、.rdata、.data...可用于遍历区段</span></span><br><span class="line">    DWORD   TimeDateStamp;	<span class="comment">// 文件创建时间戳</span></span><br><span class="line">    DWORD   PointerToSymbolTable;	<span class="comment">// 指向符号表的指针，没什么用了</span></span><br><span class="line">    DWORD   NumberOfSymbols;	<span class="comment">// 符号表中符号的数量</span></span><br><span class="line">    WORD    SizeOfOptionalHeader;	<span class="comment">// 扩展头的大小</span></span><br><span class="line">    WORD    Characteristics;	<span class="comment">// PE文件的属性，exe：0x010F，dll：0x0210</span></span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Optional header format.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Standard fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    WORD    Magic;	<span class="comment">// 文件类型的标识，普通可执行文件：0x10B</span></span><br><span class="line">    BYTE    MajorLinkerVersion;	<span class="comment">// 链接器的主版本号</span></span><br><span class="line">    BYTE    MinorLinkerVersion;	<span class="comment">// 链接器的子版本号</span></span><br><span class="line">    DWORD   SizeOfCode;	<span class="comment">// 按磁盘扇区的整倍数计算</span></span><br><span class="line">    DWORD   SizeOfInitializedData;	<span class="comment">// 已初始化的数据块的大小</span></span><br><span class="line">    DWORD   SizeOfUninitializedData;	<span class="comment">// 未初始化的数据块的大小</span></span><br><span class="line">    DWORD   AddressOfEntryPoint;	<span class="comment">// 程序入口的RVA(相对虚拟地址)</span></span><br><span class="line">    DWORD   BaseOfCode;	<span class="comment">// 代码段的起始RVA，一般为0x1000</span></span><br><span class="line">    DWORD   BaseOfData;	<span class="comment">// 数据段的起始RVA，一般位于代码段之后	</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NT additional fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    DWORD   ImageBase;	<span class="comment">// 程序的首选装载地址，Windows优先将文件装入到由ImageBase字段指定的地址中</span></span><br><span class="line">    DWORD   SectionAlignment;	<span class="comment">// 内存中的区块的对齐大小</span></span><br><span class="line">    DWORD   FileAlignment;	<span class="comment">// 文件中的区块的对齐大小</span></span><br><span class="line">    WORD    MajorOperatingSystemVersion;	<span class="comment">// 要求操作系统最低版本号的主版本号</span></span><br><span class="line">    WORD    MinorOperatingSystemVersion;	<span class="comment">// 要求操作系统最低版本号的子版本号</span></span><br><span class="line">    WORD    MajorImageVersion;	<span class="comment">// 可运行于操作系统的主版本号</span></span><br><span class="line">    WORD    MinorImageVersion;	<span class="comment">// 可运行于操作系统的子版本号</span></span><br><span class="line">    WORD    MajorSubsystemVersion;	<span class="comment">// 要求最低子系统版本的主版本号</span></span><br><span class="line">    WORD    MinorSubsystemVersion;	<span class="comment">// 要求最低子系统版本子主版本号</span></span><br><span class="line">    DWORD   Win32VersionValue;	<span class="comment">// 保留值，必须为0</span></span><br><span class="line">    DWORD   SizeOfImage;	<span class="comment">// 映像装入内存后的总尺寸</span></span><br><span class="line">    DWORD   SizeOfHeaders;	<span class="comment">// 所有头(DOS头、PE头) + 区块表的尺寸大小</span></span><br><span class="line">    DWORD   CheckSum;	<span class="comment">// 映像文件的校验和</span></span><br><span class="line">    WORD    Subsystem;	<span class="comment">// 可执行文件期望的子系统</span></span><br><span class="line">    WORD    DllCharacteristics;	<span class="comment">// DllMain()函数何时被调用，默认为 0</span></span><br><span class="line">    DWORD   SizeOfStackReserve;	<span class="comment">// 初始化时的栈大小</span></span><br><span class="line">    DWORD   SizeOfStackCommit;	<span class="comment">// 初始化时实际提交的栈大小</span></span><br><span class="line">    DWORD   SizeOfHeapReserve;	<span class="comment">// 初始化时保留的堆大小</span></span><br><span class="line">    DWORD   SizeOfHeapCommit;	<span class="comment">// 初始化时实际提交的堆大小</span></span><br><span class="line">    DWORD   LoaderFlags;	<span class="comment">// 与调试有关，默认为 0 </span></span><br><span class="line">    DWORD   NumberOfRvaAndSizes;	<span class="comment">// 下边数据目录的项数，这个字段自Windows NT 发布以来一直是16</span></span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];	<span class="comment">// 数据目录表</span></span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">常用的三种地址：</span><br><span class="line">VA：虚拟内存地址，00000000~0FFFFFFFh，等于进程的基址+相对虚拟内存地址</span><br><span class="line">RVA：相对虚拟内存地址，记录模块相对于基址的偏移</span><br><span class="line">FOA：File Offset Address，文件偏移地址，某个位置距离文件头(MZ)的偏移</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 各种标志的值，重点关注MZ和PE00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DOS_SIGNATURE                 0x5A4D      <span class="comment">// MZ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_OS2_SIGNATURE                 0x454E      <span class="comment">// NE</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_OS2_SIGNATURE_LE              0x454C      <span class="comment">// LE</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_VXD_SIGNATURE                 0x454C      <span class="comment">// LE</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_NT_SIGNATURE                  0x00004550  <span class="comment">// PE00</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 运行平台的宏</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_TARGET_HOST       0x0001  <span class="comment">// Useful for indicating we want to interact with the host and not a WoW guest.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_I386              0x014c  <span class="comment">// Intel 386.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_R3000             0x0162  <span class="comment">// MIPS little-endian, 0x160 big-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_R4000             0x0166  <span class="comment">// MIPS little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_R10000            0x0168  <span class="comment">// MIPS little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_WCEMIPSV2         0x0169  <span class="comment">// MIPS little-endian WCE v2</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ALPHA             0x0184  <span class="comment">// Alpha_AXP</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH3               0x01a2  <span class="comment">// SH3 little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH3DSP            0x01a3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH3E              0x01a4  <span class="comment">// SH3E little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH4               0x01a6  <span class="comment">// SH4 little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_SH5               0x01a8  <span class="comment">// SH5</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ARM               0x01c0  <span class="comment">// ARM Little-Endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_THUMB             0x01c2  <span class="comment">// ARM Thumb/Thumb-2 Little-Endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ARMNT             0x01c4  <span class="comment">// ARM Thumb-2 Little-Endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_AM33              0x01d3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_POWERPC           0x01F0  <span class="comment">// IBM PowerPC Little-Endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_POWERPCFP         0x01f1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_IA64              0x0200  <span class="comment">// Intel 64</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_MIPS16            0x0266  <span class="comment">// MIPS</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ALPHA64           0x0284  <span class="comment">// ALPHA64</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_MIPSFPU           0x0366  <span class="comment">// MIPS</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_MIPSFPU16         0x0466  <span class="comment">// MIPS</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_AXP64             IMAGE_FILE_MACHINE_ALPHA64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_TRICORE           0x0520  <span class="comment">// Infineon</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_CEF               0x0CEF</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_EBC               0x0EBC  <span class="comment">// EFI Byte Code</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_AMD64             0x8664  <span class="comment">// AMD64 (K8)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_M32R              0x9041  <span class="comment">// M32R little-endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_ARM64             0xAA64  <span class="comment">// ARM64 Little-Endian</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_MACHINE_CEE               0xC0EE</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 常见PE属性</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_RELOCS_STRIPPED           0x0001  <span class="comment">// Relocation info stripped from file.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_EXECUTABLE_IMAGE          0x0002  <span class="comment">// File is executable  (i.e. no unresolved external references).</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_LINE_NUMS_STRIPPED        0x0004  <span class="comment">// Line nunbers stripped from file.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_LOCAL_SYMS_STRIPPED       0x0008  <span class="comment">// Local symbols stripped from file.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_AGGRESIVE_WS_TRIM         0x0010  <span class="comment">// Aggressively trim working set</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_LARGE_ADDRESS_AWARE       0x0020  <span class="comment">// App can handle &gt;2gb addresses</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_BYTES_REVERSED_LO         0x0080  <span class="comment">// Bytes of machine word are reversed.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_32BIT_MACHINE             0x0100  <span class="comment">// 32 bit word machine.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_DEBUG_STRIPPED            0x0200  <span class="comment">// Debugging info stripped from file in .DBG file</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP   0x0400  <span class="comment">// If Image is on removable media, copy and run from the swap file.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_NET_RUN_FROM_SWAP         0x0800  <span class="comment">// If Image is on Net, copy and run from the swap file.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_SYSTEM                    0x1000  <span class="comment">// System File.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_DLL                       0x2000  <span class="comment">// File is a DLL.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_UP_SYSTEM_ONLY            0x4000  <span class="comment">// File should only be run on a UP machine</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_FILE_BYTES_REVERSED_HI         0x8000  <span class="comment">// Bytes of machine word are reversed.</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可执行文件期望的子系统的值</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_UNKNOWN              0   <span class="comment">// Unknown subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_NATIVE               1   <span class="comment">// Image doesn&#x27;t require a subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_WINDOWS_GUI          2   <span class="comment">// Image runs in the Windows GUI subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_WINDOWS_CUI          3   <span class="comment">// Image runs in the Windows character subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_OS2_CUI              5   <span class="comment">// image runs in the OS/2 character subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_POSIX_CUI            7   <span class="comment">// image runs in the Posix character subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_NATIVE_WINDOWS       8   <span class="comment">// image is a native Win9x driver.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_WINDOWS_CE_GUI       9   <span class="comment">// Image runs in the Windows CE subsystem.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_EFI_APPLICATION      10  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_EFI_BOOT_SERVICE_DRIVER  11   <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_EFI_RUNTIME_DRIVER   12  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_EFI_ROM              13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_XBOX                 14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_WINDOWS_BOOT_APPLICATION 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SUBSYSTEM_XBOX_CODE_CATALOG    17</span></span><br></pre></td></tr></table></figure>
<h2 id="区段"><a href="#区段" class="headerlink" title="区段"></a>区段</h2><p>区段表：</p>
<p><img src="https://s1.ax1x.com/2023/07/24/pCLqBnA.png" alt="区段表"></p>
<p>常用区段：</p>
<ul>
<li>.text / .code：代码段</li>
<li>.data：可读写的数据段，存放全局变量和静态变量</li>
<li>.rdata：只读数据段</li>
<li>.idata：存放导入表信息</li>
<li>.edata：存放导出表信息</li>
<li>.rsrc：资源段</li>
<li>.bss：未初始化的数据</li>
<li>.crt：用于C++ 运行时(CRT)所添加的数据</li>
<li>.tls：TLS是线程局部存储器，用于支持通过_declspec(thread)声明的线程局部存储变量的数据，这包括数据的初始化值，也包括运行时所需要的额外变量</li>
<li>.reloc：可执行文件的基址重定位，基址重定位一般仅Dll需要的</li>
<li>.sdata：相对于全局指针的可被定位的 短的读写数据</li>
<li>.pdata：异常表,包含CPU特定的IAMGE_RUNTIME_FUNTION_ENTRY结构数组，DataDirectory中的IMAGE_DIRECTORY_ENTRY_EXCEPTION指向它.</li>
<li><strong>.</strong>didata：延迟装入输入数据，在非Release模式下可以找到</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每一个区段都是这样一个结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span> &#123;</span></span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];	<span class="comment">// 区段名</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">            DWORD   PhysicalAddress;</span><br><span class="line">            DWORD   VirtualSize;	<span class="comment">// 区段对其之前的实际大小</span></span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;	<span class="comment">// 区段载入内存后的RVA，按内存页对齐</span></span><br><span class="line">    DWORD   SizeOfRawData;	<span class="comment">// 磁盘中的大小，按文件页对齐</span></span><br><span class="line">    DWORD   PointerToRawData;	<span class="comment">// 区段在文件中的偏移</span></span><br><span class="line">    DWORD   PointerToRelocations;	<span class="comment">// 区段重定位表的偏移地址</span></span><br><span class="line">    DWORD   PointerToLinenumbers;	<span class="comment">// 行号表在文件中的偏移</span></span><br><span class="line">    WORD    NumberOfRelocations;	<span class="comment">// 区段重定位表的表项个数</span></span><br><span class="line">    WORD    NumberOfLinenumbers;	<span class="comment">// 行号表项的数量</span></span><br><span class="line">    DWORD   Characteristics;		<span class="comment">// 区段属性</span></span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 区段属性</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_REG                   0x00000000  // Reserved.</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_DSECT                 0x00000001  // Reserved.</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_NOLOAD                0x00000002  // Reserved.</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_GROUP                 0x00000004  // Reserved.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_TYPE_NO_PAD                0x00000008  <span class="comment">// Reserved.</span></span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_COPY                  0x00000010  // Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_CNT_CODE                   0x00000020  <span class="comment">// Section contains code.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_CNT_INITIALIZED_DATA       0x00000040  <span class="comment">// Section contains initialized data.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_CNT_UNINITIALIZED_DATA     0x00000080  <span class="comment">// Section contains uninitialized data.</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_OTHER                  0x00000100  <span class="comment">// Reserved.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_INFO                   0x00000200  <span class="comment">// Section contains comments or some other type of information.</span></span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_TYPE_OVER                  0x00000400  // Reserved.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_REMOVE                 0x00000800  <span class="comment">// Section contents will not become part of image.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_COMDAT                 0x00001000  <span class="comment">// Section contents comdat.</span></span></span><br><span class="line"><span class="comment">//                                           0x00002000  // Reserved.</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_MEM_PROTECTED - Obsolete   0x00004000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_NO_DEFER_SPEC_EXC          0x00004000  <span class="comment">// Reset speculative exceptions handling bits in the TLB entries for this section.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_GPREL                      0x00008000  <span class="comment">// Section content can be accessed relative to GP</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_FARDATA                0x00008000</span></span><br><span class="line"><span class="comment">//      IMAGE_SCN_MEM_SYSHEAP  - Obsolete    0x00010000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_PURGEABLE              0x00020000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_16BIT                  0x00020000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_LOCKED                 0x00040000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_PRELOAD                0x00080000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_1BYTES               0x00100000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_2BYTES               0x00200000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_4BYTES               0x00300000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_8BYTES               0x00400000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_16BYTES              0x00500000  <span class="comment">// Default alignment if no others are specified.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_32BYTES              0x00600000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_64BYTES              0x00700000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_128BYTES             0x00800000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_256BYTES             0x00900000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_512BYTES             0x00A00000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_1024BYTES            0x00B00000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_2048BYTES            0x00C00000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_4096BYTES            0x00D00000  <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_8192BYTES            0x00E00000  <span class="comment">//</span></span></span><br><span class="line"><span class="comment">// Unused                                    0x00F00000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_ALIGN_MASK                 0x00F00000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_LNK_NRELOC_OVFL            0x01000000  <span class="comment">// Section contains extended relocations.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_DISCARDABLE            0x02000000  <span class="comment">// Section can be discarded.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_NOT_CACHED             0x04000000  <span class="comment">// Section is not cachable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_NOT_PAGED              0x08000000  <span class="comment">// Section is not pageable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_SHARED                 0x10000000  <span class="comment">// Section is shareable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_EXECUTE                0x20000000  <span class="comment">// Section is executable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_READ                   0x40000000  <span class="comment">// Section is readable.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SCN_MEM_WRITE                  0x80000000  <span class="comment">// Section is writeable.</span></span></span><br></pre></td></tr></table></figure>
<h2 id="数据目录表"><a href="#数据目录表" class="headerlink" title="数据目录表"></a>数据目录表</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DATA_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   VirtualAddress;	<span class="comment">// 虚拟地址</span></span><br><span class="line">    DWORD   Size;	<span class="comment">// 尺寸</span></span><br><span class="line">&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目录顺序</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_EXPORT          0   <span class="comment">// Export Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_IMPORT          1   <span class="comment">// Import Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_RESOURCE        2   <span class="comment">// Resource Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_EXCEPTION       3   <span class="comment">// Exception Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_SECURITY        4   <span class="comment">// Security Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_BASERELOC       5   <span class="comment">// Base Relocation Table</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_DEBUG           6   <span class="comment">// Debug Directory</span></span></span><br><span class="line"><span class="comment">//      IMAGE_DIRECTORY_ENTRY_COPYRIGHT       7   // (X86 usage)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_ARCHITECTURE    7   <span class="comment">// Architecture Specific Data，保留字段，必须为0</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_GLOBALPTR       8   <span class="comment">// RVA of GP</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_TLS             9   <span class="comment">// TLS Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG    10   <span class="comment">// Load Configuration Directory</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT   11   <span class="comment">// Bound Import Directory in headers</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_IAT            12   <span class="comment">// Import Address Table</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT   13   <span class="comment">// Delay Load Import Descriptors</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR 14   <span class="comment">// COM Runtime descriptor</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD   Characteristics;            <span class="comment">// 0 for terminating null import descriptor</span></span><br><span class="line">        DWORD   OriginalFirstThunk;         <span class="comment">// 即INT的RVA</span></span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    DWORD   TimeDateStamp;                  <span class="comment">// 0 if not bound,</span></span><br><span class="line">                                            <span class="comment">// -1 if bound, and real date\time stamp</span></span><br><span class="line">                                            <span class="comment">//     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span></span><br><span class="line">                                            <span class="comment">// O.W. date/time stamp of DLL bound to (Old BIND)</span></span><br><span class="line"></span><br><span class="line">    DWORD   ForwarderChain;                 <span class="comment">// -1 if no forwarders</span></span><br><span class="line">    DWORD   Name;					      <span class="comment">// 动态链接库的名称(kernel32.dll)的RVA</span></span><br><span class="line">    DWORD   FirstThunk;                     <span class="comment">// 即IAT的RVA</span></span><br><span class="line">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_THUNK_DATA32</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD ForwarderString;      <span class="comment">// PBYTE </span></span><br><span class="line">        DWORD Function;             <span class="comment">// PDWORD</span></span><br><span class="line">        DWORD Ordinal;</span><br><span class="line">        DWORD AddressOfData;        <span class="comment">// PIMAGE_IMPORT_BY_NAME，指向IMAGE_IMPORT_BY_NAME结构</span></span><br><span class="line">    &#125; u1;</span><br><span class="line">&#125; IMAGE_THUNK_DATA32;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_THUNK_DATA32 *PIMAGE_THUNK_DATA32;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_BY_NAME</span> &#123;</span></span><br><span class="line">    WORD    Hint;	<span class="comment">// 需要导入函数的函数序号</span></span><br><span class="line">    CHAR   Name[<span class="number">1</span>];	<span class="comment">// 需要导入函数的函数名</span></span><br><span class="line">&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</span><br></pre></td></tr></table></figure>
<h2 id="导出表"><a href="#导出表" class="headerlink" title="导出表"></a>导出表</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   Characteristics;	<span class="comment">// 保留段，一直为0</span></span><br><span class="line">    DWORD   TimeDateStamp;		<span class="comment">// 创建时间</span></span><br><span class="line">    WORD    MajorVersion;</span><br><span class="line">    WORD    MinorVersion;</span><br><span class="line">    DWORD   Name;				<span class="comment">// 指向模块名的RVA</span></span><br><span class="line">    DWORD   Base;				<span class="comment">// 输出API函数的索引值的基数(1)</span></span><br><span class="line">    DWORD   NumberOfFunctions;	<span class="comment">// 导出函数个数</span></span><br><span class="line">    DWORD   NumberOfNames;		<span class="comment">// 导出函数名个数，很多函数没有函数名</span></span><br><span class="line">    DWORD   AddressOfFunctions;     <span class="comment">// RVA from base of image</span></span><br><span class="line">    DWORD   AddressOfNames;         <span class="comment">// RVA from base of image</span></span><br><span class="line">    DWORD   AddressOfNameOrdinals;  <span class="comment">// RVA from base of image</span></span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure>
<h2 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h2><p>主要用于动态链接库</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_BASE_RELOCATION</span> &#123;</span></span><br><span class="line">    DWORD   VirtualAddress;	<span class="comment">// 需要重定位的RVA，一般为0x1000的倍数</span></span><br><span class="line">    DWORD   SizeOfBlock;	<span class="comment">// 结构体和数组TypeOffset的体积总和 </span></span><br><span class="line"><span class="comment">//  WORD    TypeOffset[1];</span></span><br><span class="line">&#125; IMAGE_BASE_RELOCATION;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_BASE_RELOCATION UNALIGNED * PIMAGE_BASE_RELOCATION;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TYPE</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		WORD Offset  :  <span class="number">12</span>;	</span><br><span class="line">		WORD Type : <span class="number">4</span>;	<span class="comment">// 4bit</span></span><br><span class="line">	&#125;TYPE, *PTYPE;</span><br></pre></td></tr></table></figure>
<h2 id="TLS表"><a href="#TLS表" class="headerlink" title="TLS表"></a>TLS表</h2><p><img src="https://s1.ax1x.com/2023/07/24/pCLqa1e.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_TLS_DIRECTORY32</span> &#123;</span></span><br><span class="line">    DWORD   StartAddressOfRawData;	<span class="comment">// 内存起始地址</span></span><br><span class="line">    DWORD   EndAddressOfRawData;	<span class="comment">// 内存结束地址</span></span><br><span class="line">    DWORD   AddressOfIndex;             <span class="comment">// TLS的索引</span></span><br><span class="line">    DWORD   AddressOfCallBacks;         <span class="comment">// PIMAGE_TLS_CALLBACK *，回调函数的一个数组</span></span><br><span class="line">    DWORD   SizeOfZeroFill;		<span class="comment">// 零填充区域的长度</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD Characteristics;	<span class="comment">// 保留字段</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            DWORD Reserved0 : <span class="number">20</span>;</span><br><span class="line">            DWORD Alignment : <span class="number">4</span>;</span><br><span class="line">            DWORD Reserved1 : <span class="number">8</span>;</span><br><span class="line">        &#125; DUMMYSTRUCTNAME;</span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line"></span><br><span class="line">&#125; IMAGE_TLS_DIRECTORY32;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_TLS_DIRECTORY32 * PIMAGE_TLS_DIRECTORY32;</span><br></pre></td></tr></table></figure>
<h2 id="延迟导入表"><a href="#延迟导入表" class="headerlink" title="延迟导入表"></a>延迟导入表</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DELAYLOAD_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD AllAttributes;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            DWORD RvaBased : <span class="number">1</span>;             <span class="comment">// Delay load version 2</span></span><br><span class="line">            DWORD ReservedAttributes : <span class="number">31</span>;</span><br><span class="line">        &#125; DUMMYSTRUCTNAME;</span><br><span class="line">    &#125; Attributes;	<span class="comment">// 属性</span></span><br><span class="line"></span><br><span class="line">    DWORD DllNameRVA;                       <span class="comment">// 动态链接库名称的RVA</span></span><br><span class="line">    DWORD ModuleHandleRVA;                  <span class="comment">// 模块句柄的RVA</span></span><br><span class="line">    DWORD ImportAddressTableRVA;            <span class="comment">// IAT的RVA</span></span><br><span class="line">    DWORD ImportNameTableRVA;               <span class="comment">// INT的RVA</span></span><br><span class="line">    DWORD BoundImportAddressTableRVA;       <span class="comment">// RVA to an optional bound IAT</span></span><br><span class="line">    DWORD UnloadInformationTableRVA;        <span class="comment">// RVA to an optional unload info table</span></span><br><span class="line">    DWORD TimeDateStamp;                    <span class="comment">// 0 if not bound,</span></span><br><span class="line">                                            <span class="comment">// Otherwise, date/time of the target DLL</span></span><br><span class="line"></span><br><span class="line">&#125; IMAGE_DELAYLOAD_DESCRIPTOR, *PIMAGE_DELAYLOAD_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">const</span> IMAGE_DELAYLOAD_DESCRIPTOR *PCIMAGE_DELAYLOAD_DESCRIPTOR;</span><br></pre></td></tr></table></figure>
<h2 id="资源表"><a href="#资源表" class="headerlink" title="资源表"></a>资源表</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_RESOURCE_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   Characteristics;	<span class="comment">// 00000000</span></span><br><span class="line">    DWORD   TimeDateStamp;		<span class="comment">// 资源创建时间	</span></span><br><span class="line">    WORD    MajorVersion;		<span class="comment">// 4</span></span><br><span class="line">    WORD    MinorVersion;		<span class="comment">// 0</span></span><br><span class="line">    WORD    NumberOfNamedEntries;	<span class="comment">// 以字符串作为资源标识的条目的个数</span></span><br><span class="line">    WORD    NumberOfIdEntries;	<span class="comment">// 以数字作为资源标识的条目的个数</span></span><br><span class="line"><span class="comment">//  IMAGE_RESOURCE_DIRECTORY_ENTRY DirectoryEntries[];</span></span><br><span class="line">&#125; IMAGE_RESOURCE_DIRECTORY, *PIMAGE_RESOURCE_DIRECTORY;</span><br></pre></td></tr></table></figure>
<p><img src="https://s1.ax1x.com/2023/07/24/pCLqwXd.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_RESOURCE_DIRECTORY_ENTRY</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            DWORD NameOffset:<span class="number">31</span>;	<span class="comment">// 资源表的偏移</span></span><br><span class="line">            DWORD NameIsString:<span class="number">1</span>;	<span class="comment">// 资源为字符串，值为1表示资源为字符串-&gt;开发者的资源，不为1表示是系统资源</span></span><br><span class="line">        &#125; DUMMYSTRUCTNAME;</span><br><span class="line">        DWORD   Name;		<span class="comment">// 资源的类型即资源名</span></span><br><span class="line">        WORD    Id;			<span class="comment">// 资源的数字ID</span></span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD   OffsetToData;	<span class="comment">// 数据偏移的地址</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            DWORD   OffsetToDirectory:<span class="number">31</span>;	<span class="comment">// 子目录偏移的地址</span></span><br><span class="line">            DWORD   DataIsDirectory:<span class="number">1</span>;		<span class="comment">// 数据是目录，值为1表示数据是目录</span></span><br><span class="line">        &#125; DUMMYSTRUCTNAME2;</span><br><span class="line">    &#125; DUMMYUNIONNAME2;</span><br><span class="line">&#125; IMAGE_RESOURCE_DIRECTORY_ENTRY, *PIMAGE_RESOURCE_DIRECTORY_ENTRY;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_RESOURCE_DIR_STRING_U</span> &#123;</span></span><br><span class="line">    WORD    Length;		<span class="comment">// 字符串长度</span></span><br><span class="line">    WCHAR   NameString[ <span class="number">1</span> ];	<span class="comment">// 字符串数组</span></span><br><span class="line">&#125; IMAGE_RESOURCE_DIR_STRING_U, *PIMAGE_RESOURCE_DIR_STRING_U;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_RESOURCE_DATA_ENTRY</span> &#123;</span></span><br><span class="line">    DWORD   OffsetToData;	<span class="comment">// 资源数据的RVA</span></span><br><span class="line">    DWORD   Size;		<span class="comment">// 资源数据的长度</span></span><br><span class="line">    DWORD   CodePage;	<span class="comment">// 代码页</span></span><br><span class="line">    DWORD   Reserved;	<span class="comment">// 保留字段</span></span><br><span class="line">&#125; IMAGE_RESOURCE_DATA_ENTRY, *PIMAGE_RESOURCE_DATA_ENTRY;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 资源总数 = NumberOfNamedEntries + NumberOfIdEntries</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_RESOURCE_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   Characteristics;</span><br><span class="line">    DWORD   TimeDateStamp;</span><br><span class="line">    WORD    MajorVersion;</span><br><span class="line">    WORD    MinorVersion;</span><br><span class="line">    WORD    NumberOfNamedEntries;</span><br><span class="line">    WORD    NumberOfIdEntries;</span><br><span class="line"><span class="comment">//  IMAGE_RESOURCE_DIRECTORY_ENTRY DirectoryEntries[];</span></span><br><span class="line">&#125; IMAGE_RESOURCE_DIRECTORY, *PIMAGE_RESOURCE_DIRECTORY;</span><br></pre></td></tr></table></figure>
<h2 id="PE文件解析代码"><a href="#PE文件解析代码" class="headerlink" title="PE文件解析代码"></a>PE文件解析代码</h2><h4 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算数据目录表起始位置到文件头(MZ)的偏移</span></span><br><span class="line">DWORD <span class="title function_">RvaToOffset</span><span class="params">(DWORD dwRva, <span class="type">char</span> *buffer)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析导入表的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ImportTbale</span><span class="params">(<span class="type">char</span> *buffer)</span>;</span><br><span class="line"><span class="comment">// 解析导出表的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ExportTable</span><span class="params">(<span class="type">char</span> *buffer)</span>;</span><br><span class="line"><span class="comment">// 解析重定位表的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">RelocTable</span><span class="params">(<span class="type">char</span> *buffer)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析TLS的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">TLSTable</span><span class="params">(<span class="type">char</span> *buffer)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析延迟导入表的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">DelayImport</span><span class="params">(<span class="type">char</span> *buffer)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Entry.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	FILE *pFile = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">errno_t</span> err;</span><br><span class="line">	<span class="type">char</span> *buffer;</span><br><span class="line">	<span class="type">int</span> nFileLength = <span class="number">0</span>;</span><br><span class="line">	err = fopen_s(&amp;pFile, <span class="string">&quot;D:\\desktop\\PEiD.exe&quot;</span>, <span class="string">&quot;rb&quot;</span>);	<span class="comment">// 二进制形式读取PE文件,注意反斜杠前面需要再加一个反斜杠进行转义</span></span><br><span class="line">	fseek(pFile, <span class="number">0</span>, SEEK_END);</span><br><span class="line">	nFileLength = ftell(pFile);</span><br><span class="line">	rewind(pFile);</span><br><span class="line">	<span class="type">int</span> imageLength = nFileLength * <span class="keyword">sizeof</span>(<span class="type">char</span>) + <span class="number">1</span>;</span><br><span class="line">	buffer = (<span class="type">char</span> *)<span class="built_in">malloc</span>(imageLength);</span><br><span class="line">	<span class="built_in">memset</span>(buffer, <span class="number">0</span>, nFileLength * <span class="keyword">sizeof</span>(<span class="type">char</span>) + <span class="number">1</span>);</span><br><span class="line">	fread(buffer, <span class="number">1</span>, imageLength, pFile);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// DOS头解析</span></span><br><span class="line">	PIMAGE_DOS_HEADER Read_Dos_Header;</span><br><span class="line">	Read_Dos_Header = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;--- MS DOS HEADER ---\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;DOS标志位：%x\n&quot;</span>, Read_Dos_Header-&gt;e_magic);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;PE头偏移：%x\n\n&quot;</span>, Read_Dos_Header-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PE头解析</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;--- PE HEADER ---\n&quot;</span>);</span><br><span class="line">	PIMAGE_NT_HEADERS Read_NT_Headers;	<span class="comment">// PE头，包含标准PT头和扩展PE头</span></span><br><span class="line">	Read_NT_Headers = (PIMAGE_NT_HEADERS)(buffer + Read_Dos_Header-&gt;e_lfanew);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;PE标志位：%x\n&quot;</span>, Read_NT_Headers-&gt;Signature);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;运行平台：%x\n&quot;</span>, Read_NT_Headers-&gt;FileHeader.Machine);	<span class="comment">// FileHeader: 标准头</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;程序入口点：%x\n\n&quot;</span>, Read_NT_Headers-&gt;OptionalHeader.ImageBase);	<span class="comment">// OptionalHeader：扩展头</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 区段解析遍历, 根据标准PE头中的NumberOfSections进行遍历</span></span><br><span class="line">	PIMAGE_SECTION_HEADER Read_Section_Header = IMAGE_FIRST_SECTION(Read_NT_Headers);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;--- Section HEADER ---\n&quot;</span>);</span><br><span class="line">	PIMAGE_FILE_HEADER PFileHeder = &amp;(Read_NT_Headers-&gt;FileHeader);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PFileHeder-&gt;NumberOfSections; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Name(区段名)：%s\n&quot;</span>, Read_Section_Header[i].Name);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;VOffset(起始的相对虚拟地址)：%08X\n&quot;</span>, Read_Section_Header[i].VirtualAddress);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;VSize(内存区段大小)：%08X\n&quot;</span>, Read_Section_Header[i].SizeOfRawData);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ROffset(文件偏移)：%08X\n&quot;</span>, Read_Section_Header[i].PointerToRawData);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;RSize(文件区段大小)：%08X\n&quot;</span>, Read_Section_Header[i].Misc.VirtualSize);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;标记(区段属性)：%08X\n\n&quot;</span>, Read_Section_Header[i].Characteristics);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;---导入表信息---\n&quot;</span>);</span><br><span class="line">	ImportTbale(buffer);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;---导入表信息---\n&quot;</span>);</span><br><span class="line">	ExportTable(buffer);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*printf(&quot;---重定位表信息---\n&quot;);</span></span><br><span class="line"><span class="comment">	RelocTable(buffer);*/</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;---TLS表信息---\n&quot;</span>);</span><br><span class="line">	TLSTable(buffer);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;---延迟导入表表信息---\n&quot;</span>);</span><br><span class="line">	DelayImport(buffer);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(buffer);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 地址转换函数</span></span><br><span class="line"><span class="comment">// dwRva是某个数据目录表项的VirutualAddress</span></span><br><span class="line"><span class="comment">// buffer是读取到的PE文件缓冲区</span></span><br><span class="line">DWORD <span class="title function_">RvaToOffset</span><span class="params">(DWORD dwRva, <span class="type">char</span> *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// DOS头</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// PE头</span></span><br><span class="line">	PIMAGE_NT_HEADERS pNT = (PIMAGE_NT_HEADERS)(buffer + pDos-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 区段表</span></span><br><span class="line">	PIMAGE_SECTION_HEADER pSection = IMAGE_FIRST_SECTION(pNT);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断是否落在头部中</span></span><br><span class="line">	<span class="keyword">if</span> (dwRva &lt; pSection[<span class="number">0</span>].VirtualAddress)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> dwRva;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pNT-&gt;FileHeader.NumberOfSections; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// VirtualAddress：起始地址</span></span><br><span class="line">		<span class="comment">// Size：长度</span></span><br><span class="line">		<span class="comment">// VirtualAddress+Size：结束地址</span></span><br><span class="line">		<span class="comment">// 判断是否落在某个区段内</span></span><br><span class="line">		<span class="keyword">if</span> (dwRva &gt;= pSection[i].VirtualAddress &amp;&amp; dwRva &lt;= pSection[i].VirtualAddress + pSection[i].Misc.VirtualSize)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// dwRva - pSection[i].VirtualAddress对应数据目录表起始地址到区段起始地址的偏移Offset</span></span><br><span class="line">			<span class="comment">// pSection[i].PointerToRawData: 区段到文件头的偏移Offset</span></span><br><span class="line">			<span class="comment">// 返回数据目录表起始地址到文件头的偏移Offset</span></span><br><span class="line">			<span class="keyword">return</span> dwRva - pSection[i].VirtualAddress + pSection[i].PointerToRawData;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ImportTbale</span><span class="params">(<span class="type">char</span> *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// DOS头</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PE头</span></span><br><span class="line">	PIMAGE_NT_HEADERS pNT = (PIMAGE_NT_HEADERS)(buffer + pDos-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定位导入表</span></span><br><span class="line">	PIMAGE_DATA_DIRECTORY pImoprtDir = (PIMAGE_DATA_DIRECTORY)(pNT-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_IMPORT);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 填充结构</span></span><br><span class="line">	PIMAGE_IMPORT_DESCRIPTOR pImport = (PIMAGE_IMPORT_DESCRIPTOR)(RvaToOffset(pImoprtDir-&gt;VirtualAddress, buffer) + buffer);</span><br><span class="line">	<span class="keyword">while</span> (pImport-&gt;Name != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">char</span> *szDllName = (<span class="type">char</span> *)(RvaToOffset(pImport-&gt;Name, buffer) + buffer);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;DLL名称: %s\n&quot;</span>, szDllName);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;日期时间标志: %08x\n&quot;</span>, pImport-&gt;TimeDateStamp);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ForwarderChain: %08x\n&quot;</span>, pImport-&gt;ForwarderChain);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;名称OFFSET: %08x\n&quot;</span>, pImport-&gt;Name);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;FirstThunk: %08x\n&quot;</span>, pImport-&gt;FirstThunk);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;OriginalFirstThunk: %08x\n\n&quot;</span>, pImport-&gt;OriginalFirstThunk);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 指向导入地址表的RVA</span></span><br><span class="line">		PIMAGE_THUNK_DATA pIat = (PIMAGE_THUNK_DATA)(RvaToOffset(pImport-&gt;OriginalFirstThunk, buffer) + buffer);</span><br><span class="line">		DWORD index = <span class="number">0</span>;</span><br><span class="line">		DWORD ImportOffset = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// 被导入函数的序号</span></span><br><span class="line">		<span class="keyword">while</span> (pIat-&gt;u1.Ordinal != <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ThunkRva: %08x\n&quot;</span>, pImport-&gt;OriginalFirstThunk + index);</span><br><span class="line">			ImportOffset = RvaToOffset(pImport-&gt;OriginalFirstThunk, buffer);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ThunkOffset: %08x\n&quot;</span>, ImportOffset + index);</span><br><span class="line">			index += <span class="number">4</span>;</span><br><span class="line">			<span class="keyword">if</span> ((pIat-&gt;u1.Ordinal &amp; <span class="number">0x80000000</span>) != <span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				PIMAGE_IMPORT_BY_NAME pName = (PIMAGE_IMPORT_BY_NAME)(RvaToOffset(pIat-&gt;u1.AddressOfData, buffer) + buffer);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;API名称：%s\n&quot;</span>, pName-&gt;Name);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Hint(API序号)：%04x\n&quot;</span>, pName-&gt;Hint);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;ThunkValue：%08x\n\n&quot;</span>, pIat-&gt;u1.Function);	<span class="comment">// 被导入函数的地址</span></span><br><span class="line">			&#125;</span><br><span class="line">			pIat++;</span><br><span class="line">		&#125;</span><br><span class="line">		pImport++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ExportTable</span><span class="params">(<span class="type">char</span> *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// DOS头</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PE头</span></span><br><span class="line">	PIMAGE_NT_HEADERS pNT = (PIMAGE_NT_HEADERS)(buffer + pDos-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定位数据目录表中的导出表</span></span><br><span class="line">	PIMAGE_DATA_DIRECTORY pExportDir = pNT-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_EXPORT;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 填充导出表结构</span></span><br><span class="line">	PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)(RvaToOffset(pExportDir-&gt;VirtualAddress, buffer) + buffer);</span><br><span class="line">	<span class="type">char</span> *szName = (<span class="type">char</span> *)(RvaToOffset(pExport-&gt;Name, buffer) + buffer);</span><br><span class="line">	<span class="keyword">if</span> (pExport-&gt;AddressOfFunctions == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;当前没有导出表!\n\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;导出表OFFSET：%08x\n&quot;</span>, RvaToOffset(pExportDir-&gt;VirtualAddress, buffer));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;特征值：%08x\n&quot;</span>, pExport-&gt;Characteristics);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;基数：%08x\n&quot;</span>, pExport-&gt;Base);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;名称OFFSET：%08x\n&quot;</span>, pExport-&gt;Name);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;名称：%s\n&quot;</span>, szName);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;函数数量：%08x\n&quot;</span>, pExport-&gt;NumberOfFunctions);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;函数名数量：%08x\n&quot;</span>, pExport-&gt;NumberOfNames);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;函数地址：%08x\n&quot;</span>, pExport-&gt;AddressOfFunctions);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;函数名地址：%08x\n&quot;</span>, pExport-&gt;AddressOfNames);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;函数名称序号地址：%08x\n&quot;</span>, pExport-&gt;AddressOfNameOrdinals);</span><br><span class="line">	<span class="comment">// 函数数量</span></span><br><span class="line">	DWORD dwNumOfFun = pExport-&gt;NumberOfFunctions;</span><br><span class="line">	<span class="comment">// 函数名数量</span></span><br><span class="line">	DWORD dwNumOfNames = pExport-&gt;AddressOfNames;</span><br><span class="line">	<span class="comment">// 基数</span></span><br><span class="line">	DWORD dwBase = pExport-&gt;Base;</span><br><span class="line">	<span class="comment">// 导出地址表</span></span><br><span class="line">	PDWORD pEat32 = (PDWORD)(RvaToOffset(pExport-&gt;AddressOfFunctions, buffer) + buffer);</span><br><span class="line">	<span class="comment">// 导出名称表</span></span><br><span class="line">	PDWORD pEnt32 = (PDWORD)(RvaToOffset(pExport-&gt;AddressOfNames, buffer) + buffer);</span><br><span class="line">	<span class="comment">// 导出序号表</span></span><br><span class="line">	PWORD pId = (PWORD)(RvaToOffset(pExport-&gt;AddressOfNameOrdinals, buffer) + buffer);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; dwNumOfFun; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (pEat32[i] == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		DWORD Id = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (; Id &lt; dwNumOfNames; ++Id)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (pId[Id] == i)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (Id == dwNumOfNames)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Id: %x Address: 0x%08x Name[NULL]\n&quot;</span>, i + dwBase, pEat32[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">char</span> *szFunName = (<span class="type">char</span> *)(RvaToOffset(pEnt32[Id], buffer) + buffer);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Id: %x Address: 0x%08x Name[%s]\n&quot;</span>, i + dwBase, pEat32[i], szFunName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RelocTable</span><span class="params">(<span class="type">char</span> *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TYPE</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		WORD Offset  :  <span class="number">12</span>;	</span><br><span class="line">		WORD Type : <span class="number">4</span>;	<span class="comment">// 4bit</span></span><br><span class="line">	&#125;TYPE, *PTYPE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// DOS头</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PE头</span></span><br><span class="line">	PIMAGE_NT_HEADERS pNT = (PIMAGE_NT_HEADERS)(buffer + pDos-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定位重定位表</span></span><br><span class="line">	PIMAGE_DATA_DIRECTORY pRelocDir = (pNT-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_BASERELOC);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 填充重定位表的结构</span></span><br><span class="line">	PIMAGE_BASE_RELOCATION pReloc = (PIMAGE_BASE_RELOCATION)(RvaToOffset(pRelocDir-&gt;VirtualAddress, buffer) + buffer);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 定位区段</span></span><br><span class="line">	PIMAGE_SECTION_HEADER pSection = IMAGE_FIRST_SECTION(pNT);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (pReloc-&gt;SizeOfBlock != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 找到本0x1000字节的起始位置</span></span><br><span class="line">		DWORD dwCount = (pReloc-&gt;SizeOfBlock - <span class="number">8</span>) / <span class="number">2</span>;	<span class="comment">// 需要重定位的个数</span></span><br><span class="line">		DWORD dwRva = (pReloc-&gt;VirtualAddress);</span><br><span class="line">		PTYPE pRelocArr = (PTYPE)(pReloc + <span class="number">1</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;区段: %s\n&quot;</span>, pSection-&gt;Name);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;RVA: %08x\n&quot;</span>, dwRva);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;项目: %X H / %d\n&quot;</span>, pReloc-&gt;SizeOfBlock, pReloc-&gt;SizeOfBlock);	<span class="comment">// 进制不同</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 找到下一个0x1000字节的结构体</span></span><br><span class="line">		pReloc = (PIMAGE_BASE_RELOCATION)((<span class="type">char</span> *)pReloc + pReloc-&gt;SizeOfBlock);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; dwCount; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			PDWORD pData = (PDWORD)(RvaToOffset(pRelocArr[i].Offset + dwRva, buffer) + buffer);</span><br><span class="line">			DWORD pDataOffset = RvaToOffset(pRelocArr[i].Offset + dwRva, buffer);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;RVA: %08x\n&quot;</span>, pRelocArr[i].Offset + dwRva);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;区段: %08x\n&quot;</span>, *pData);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;偏移: %08x\n\n&quot;</span>, pDataOffset);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">TLSTable</span><span class="params">(<span class="type">char</span> *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// DOS头</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PE头</span></span><br><span class="line">	PIMAGE_NT_HEADERS pNT = (PIMAGE_NT_HEADERS)(buffer + pDos-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定位数据目录表中的TLS表</span></span><br><span class="line">	PIMAGE_DATA_DIRECTORY pTLSDir = (pNT-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_TLS);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 填充TLS结构</span></span><br><span class="line">	PIMAGE_TLS_DIRECTORY pTLS = (PIMAGE_TLS_DIRECTORY)(RvaToOffset(pTLSDir-&gt;VirtualAddress, buffer) + buffer);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;数据块开始VA：%08x\n&quot;</span>, pTLS-&gt;StartAddressOfRawData);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;数据块结束VA：%08x\n&quot;</span>, pTLS-&gt;EndAddressOfRawData);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;索引变量VA：%08x\n&quot;</span>, pTLS-&gt;AddressOfIndex);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;回调表VA：%08x\n&quot;</span>, pTLS-&gt;AddressOfCallBacks);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;填0大小：%08x\n&quot;</span>, pTLS-&gt;SizeOfZeroFill);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;特征值：%08x\n\n&quot;</span>, pTLS-&gt;Characteristics);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DelayImport</span><span class="params">(<span class="type">char</span> *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// DOS头</span></span><br><span class="line">	PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PE头</span></span><br><span class="line">	PIMAGE_NT_HEADERS pNT = (PIMAGE_NT_HEADERS)(buffer + pDos-&gt;e_lfanew);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定位数据目录表中的延迟导入表</span></span><br><span class="line">	PIMAGE_DATA_DIRECTORY pDelayLoadDir = (pNT-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 填充延迟导入表的数据结构</span></span><br><span class="line">	PIMAGE_DELAYLOAD_DESCRIPTOR pDelayLoad = (PIMAGE_DELAYLOAD_DESCRIPTOR)(RvaToOffset(pDelayLoadDir-&gt;VirtualAddress, buffer) + buffer);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (pDelayLoad-&gt;DllNameRVA != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">char</span> *szDllName = (<span class="type">char</span> *)(RvaToOffset(pDelayLoad-&gt;DllNameRVA, buffer) + buffer);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;DllName: %s\n&quot;</span>, szDllName);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Attributes: %08X\n&quot;</span>, pDelayLoad-&gt;Attributes);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ModuleHandleRVA: %08X\n&quot;</span>, pDelayLoad-&gt;ModuleHandleRVA);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ImportAddressTableRVA: %08X\n&quot;</span>, pDelayLoad-&gt;ImportAddressTableRVA);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ImportNameTableRVA: %08X\n&quot;</span>, pDelayLoad-&gt;ImportNameTableRVA);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;BoundImportAddressTableRVA: %08X\n&quot;</span>, pDelayLoad-&gt;BoundImportAddressTableRVA);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;UnloadInformationTableRVA: %08X\n&quot;</span>, pDelayLoad-&gt;UnloadInformationTableRVA);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;TimeDateStamp: %08X\n\n&quot;</span>, pDelayLoad-&gt;TimeDateStamp);</span><br><span class="line">		pDelayLoad++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://dqywy.top">DQY</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://dqywy.top/post/15941cfe.html">https://dqywy.top/post/15941cfe.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://dqywy.top" target="_blank">快乐小凳凳</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PE%E7%BB%93%E6%9E%84/">PE结构</a></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2023/07/05/pCyWWoq.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂(点击投币)</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://s1.ax1x.com/2023/04/29/p91WC6g.png" target="_blank"><img class="post-qr-code-img" src="https://s1.ax1x.com/2023/04/29/p91WC6g.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://s1.ax1x.com/2023/04/29/p91WPXQ.jpg" target="_blank"><img class="post-qr-code-img" src="https://s1.ax1x.com/2023/04/29/p91WPXQ.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></button></div><audio id="coinAudio" src="https://cdn.cbd.int/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/ba5041c3.html" title="lnk捆绑执行exe"><img class="cover" src="https://s1.ax1x.com/2023/07/05/pCyWhF0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">lnk捆绑执行exe</div></div></a></div><div class="next-post pull-right"><a href="/post/87db0641.html" title="CVE-2017-11882原理、复现和Poc解析利用"><img class="cover" src="https://s1.ax1x.com/2023/07/05/pCyWRwn.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CVE-2017-11882原理、复现和Poc解析利用</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="author_top is-center"><div class="avatar-img"><img src="https://img.gejiba.com/images/0ce1d480d1fff83afca6864f9bb7797c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">DQY</div><div class="author-info__description">虽然前方拥堵，但您仍在最优路线上</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">39</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hellodqy"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>本站图床不支持使用VPN☔</span></div><div class="announcement_content"><center><b> --- DQY ❤️ WY --- </b></center><div class="xpand" style="height:200px;"><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div></div><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople1.js"></script><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/zdog.dist.js"></script><script id="rendered-js" src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople.js"></script><style>.card-widget.card-announcement {
margin: 0;
align-items: center;
justify-content: center;
text-align: center;
}
canvas {
display: block;
margin: 0 auto;
cursor: move;
}</style></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MS-DOS%E5%A4%B4%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">MS-DOS头：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PE%E5%A4%B4"><span class="toc-number">2.</span> <span class="toc-text">PE头</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%BA%E6%AE%B5"><span class="toc-number">3.</span> <span class="toc-text">区段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95%E8%A1%A8"><span class="toc-number">4.</span> <span class="toc-text">数据目录表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E8%A1%A8"><span class="toc-number">5.</span> <span class="toc-text">导出表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8"><span class="toc-number">6.</span> <span class="toc-text">重定位表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TLS%E8%A1%A8"><span class="toc-number">7.</span> <span class="toc-text">TLS表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E5%AF%BC%E5%85%A5%E8%A1%A8"><span class="toc-number">8.</span> <span class="toc-text">延迟导入表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E8%A1%A8"><span class="toc-number">9.</span> <span class="toc-text">资源表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PE%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E4%BB%A3%E7%A0%81"><span class="toc-number">10.</span> <span class="toc-text">PE文件解析代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="toc-number">10.0.1.</span> <span class="toc-text">头文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0"><span class="toc-number">10.0.2.</span> <span class="toc-text">主函数</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">Motto🧬</p><div class="bg-ad"><div>A contented mind is a perpetual feast.<br>-- 知足常乐🍰</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://www.dqywy.top/about/">关于博主</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">猜你想看💡</p><ul class="ft-links"><li><a target="_blank" rel="noopener" href="https://www.dqywy.top/categories/%E5%8D%9A%E5%AE%A2/">🐳魔改指南</a><a target="_blank" rel="noopener" href="https://www.dqywy.top/ToDoList/">👻待做清单</a></li><li><a target="_blank" rel="noopener" href="https://www.dqywy.top/categories/">📋文章分类</a><a target="_blank" rel="noopener" href="https://www.dqywy.top/tags/">🧭文章标签</a></li><li><a target="_blank" rel="noopener" href="https://www.dqywy.top/archives/">🔍时间轴</a><a target="_blank" rel="noopener" href="https://github.com/hellodqy">⭐Github</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">推荐友链⌛</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="安知鱼の博客"><img src="https://img01.anheyu.com/useruploads/90/2023/04/23/6444e85234e51.jpg" alt="404 NOT FOUND"/></a></div><div class="img-group-item"><a target="_blank" rel="noopener" href="https://fe32.top/" title="唐志远の博客"><img src="https://bu.dusays.com/2022/05/02/626f92e193879.jpg" alt="404 NOT FOUND"/></a></div><div class="img-group-item"><a target="_blank" rel="noopener" href="https://blog.cpen.top/" title="Mycpen"><img src="https://image.cpen.top/image/avatar.jpg" alt="404 NOT FOUND"/></a></div><div class="img-group-item"><a target="_blank" rel="noopener" href="https://blog.mletter.cn" title="野原新之助"><img src="https://bj.bcebos.com/baidu-rmb-video-cover-1/bd67cdcdcb45468305f2bbb15ff17fa8.jpeg" alt="404 NOT FOUND"/></a></div></div></div></div><div class="copyright"><span><b>&copy;2023 - 2024</b></span><span><b>&nbsp;&nbsp;By DQY</b></span></div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="本站采用多线部署，主线路托管于Vercel"><img src="https://img.shields.io/badge/Theme-Vercel-pink?logo=Vercel&amp;style=plastic" alt=""/></a><a class="github-badge" target="_blank" href="https://www.algolia.com/" style="margin-inline:5px" title="本网站搜索引擎由Algolia提供"><img src="https://img.shields.io/badge/Search-Algolia-9cf?logo=algolia&amp;style=plastic" alt=""/></a><a class="github-badge" target="_blank" href="https://account.mongodb.com/" style="margin-inline:5px" title="本网站数据库由MongoDB提供"><img src="https://img.shields.io/badge/DataBase-MongoDB-orange?logo=MongoDB&amp;style=plastic" alt=""/></a><a class="github-badge" target="_blank" href="https://bz.zzzmh.cn/index" style="margin-inline:5px" title="本网站壁纸封面由极简壁纸提供"><img src="https://img.shields.io/badge/Wallpaper-Minimalism-ff69b4?logo=Hexo&amp;style=plastic" alt=""/></a><a class="github-badge" target="_blank" href="https://smms.app/" style="margin-inline:5px" title="本网站图床由SMMS提供"><img src="https://img.shields.io/badge/Photos-SMMS-red?logo=smashingmagazine&amp;style=plastic" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://blog.dqywy.top',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://blog.dqywy.top',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer src="/js/light.js"></script><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><script defer src="/js/runtime.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var qweather_key = '5c91cdc36c47446fa69acf662f28d723';
  var gaud_map_key = 'dc64efa9d717bfba5a827a014cde4f5f';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '106.607808,29.531873';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>